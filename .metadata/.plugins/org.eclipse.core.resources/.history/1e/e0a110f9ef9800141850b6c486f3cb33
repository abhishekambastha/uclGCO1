package timeLapseMode;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.GridLayout;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.IOException;
import java.io.StringWriter;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JEditorPane;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSlider;
import javax.swing.JSpinner;
import javax.swing.SpinnerNumberModel;
import javax.swing.Timer;

import org.apache.commons.io.FileUtils;

import com.googlecode.jatl.Html;

public class TimeLapse extends JPanel {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	JSlider hours, mins, cents, secs;
	JLabel hourCount, minCounts, secCount, centCounts;
	JSpinner spinner;

	private boolean isRunning = false;

	public int getHourSliderMils() {
		return hourSliderMils;
	}

	public int getMinSliderMils() {
		return minSliderMils;
	}

	public int getSecSliderMils() {
		return secSliderMils;
	}

	public int getCentSliderMils() {
		return centSliderMils;
	}

	int hourSliderMils;
	int minSliderMils;
	int secSliderMils;
	int centSliderMils;

	JSpinner timeSpanHours = new JSpinner(new SpinnerNumberModel(0.0, 0.0,
			999.0, 1));
	JSpinner timeSpanMins = new JSpinner(
			new SpinnerNumberModel(0.0, 0.0, 59, 1));
	JSpinner timeSpanSecs = new JSpinner(
			new SpinnerNumberModel(0.0, 0.0, 59, 1));
	JSpinner timeSpanCents = new JSpinner(new SpinnerNumberModel(0.0, 0.0, 99,
			1));
	JSpinner snap = new JSpinner(new SpinnerNumberModel(0.0, 0.0, 999.0, 1));

	Timer timer;

	static JLabel count = new JLabel("Taken so far : 0");
	static int counter = 0;
	JButton btnSave, btnView, btnStart;

	public TimeLapse() {

		setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));

		add(Box.createRigidArea(new Dimension(500, 200)));

		JLabel hourLabel = new JLabel("HH");
		hourLabel.setHorizontalAlignment(JLabel.CENTER);
		JLabel minLabel = new JLabel("MM");
		minLabel.setHorizontalAlignment(JLabel.CENTER);
		JLabel secLabel = new JLabel("SS");
		secLabel.setHorizontalAlignment(JLabel.CENTER);
		JLabel centsLabel = new JLabel(".xx");
		centsLabel.setHorizontalAlignment(JLabel.CENTER);

		JPanel timePane = new JPanel();
		timePane.setLayout(new GridLayout(2, 3));
		timePane.setBorder(BorderFactory.createLineBorder(Color.black));
		timePane.add(timeSpanHours);
		timePane.add(timeSpanMins);
		timePane.add(timeSpanSecs);
		timePane.add(timeSpanCents);
		timePane.add(hourLabel);
		timePane.add(minLabel);
		timePane.add(secLabel);
		timePane.add(centsLabel);
		timePane.setPreferredSize(new Dimension(300, 100));
		timePane.setMinimumSize(new Dimension(300, 100));
		timePane.setMaximumSize(new Dimension(300, 100));

		add(timePane);

		add(Box.createRigidArea(new Dimension(500, 50)));
		count.setHorizontalAlignment(JLabel.CENTER);
		count.setAlignmentX(CENTER_ALIGNMENT);
		add(count);

		btnSave = new JButton("Save Number of Snaps Taken");
		btnSave.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent e) {
				StringWriter sw = new StringWriter();
				new Html(sw) {
					{
						html().head();
						title().text("Number of Photos Taken in a Time-Lapse")
								.end();
						h1().text(
								"The number of photos taken in this time-lapse was: "
										+ Integer.toString(counter)).end();
						h2().text(
								"This was saved on "
										+ new java.util.Date().toString())
								.end();
						done();
						String result = sw.getBuffer().toString();
						// For viewing the result string in the console:
						// System.out.println(result);
						try {
							// Use FileUtils from Apache Commons io to write
							// string to a file
							FileUtils
									.writeStringToFile(
											new File(
													"Number of time lapse photos.html"),
											result);
						} catch (IOException e1) {
							e1.printStackTrace();
						}
					}
				};
			}
		});
		btnSave.setPreferredSize(new Dimension(200, 50));
		btnSave.setMaximumSize(new Dimension(200, 50));
		btnSave.setMinimumSize(new Dimension(200, 50));
		btnSave.setAlignmentX(CENTER_ALIGNMENT);
		add(Box.createRigidArea(new Dimension(50, 5)));
		add(btnSave);

		btnView = new JButton("View Saved File");
		btnView.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent e) {
				if (new File("Number of time lapse photos.html").isFile() == true) {
					try {
						// Use FileUtils from Apache Commons io to read file to
						// a string
						String htmlFile = FileUtils.readFileToString(new File(
								"Number of time lapse photos.html"));
						// For viewing the read string in the console:
						// System.out.println(htmlFile);

						// JEditorPane & JScrollPane are used to display the
						// saved file in a new panel.
						JEditorPane disp = new JEditorPane("text/html",
								htmlFile);
						disp.setEditable(false);
						JScrollPane scrollPane = new JScrollPane(disp);
						JFrame jf = new JFrame("Saved File");
						jf.getContentPane()
								.add(scrollPane, BorderLayout.CENTER);
						jf.setSize(new Dimension(600, 300));
						jf.setLocationRelativeTo(null);
						jf.setVisible(true);

					} catch (IOException e1) {
						e1.printStackTrace();
					}
				} else {
					JOptionPane.showMessageDialog(null,
							"File does not exist yet.");
				}
			};

		});
		btnView.setPreferredSize(new Dimension(200, 50));
		btnView.setMaximumSize(new Dimension(200, 50));
		btnView.setMinimumSize(new Dimension(200, 50));
		btnView.setAlignmentX(CENTER_ALIGNMENT);
		add(Box.createRigidArea(new Dimension(50, 5)));
		add(btnView);

		btnStart = new JButton("Start");
		btnStart.setPreferredSize(new Dimension(150, 50));
		btnStart.setMaximumSize(new Dimension(150, 50));
		btnStart.setMinimumSize(new Dimension(150, 50));
		btnStart.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				double timeInt = 0;
				int numSnaps = 0;

				timeInt += 3600 * (double) timeSpanHours.getValue();
				timeInt += 60 * (double) timeSpanMins.getValue();
				timeInt += (double) timeSpanSecs.getValue();
				timeInt += (double) timeSpanCents.getValue() / 100;

				numSnaps = (int) (double) snap.getValue();

				if (!isRunning) {
					btnStart.setText("Stop");
				} else {
					btnStart.setText("Start");
				}
				System.out.println(timeInt);
				startLapsing(numSnaps, timeInt);
			}
		});

		add(Box.createRigidArea(new Dimension(50, 20)));

		JLabel snapLabel = new JLabel("Number of Snaps");
		snapLabel.setHorizontalAlignment(JLabel.CENTER);
		snapLabel.setAlignmentX(CENTER_ALIGNMENT);
		add(snapLabel);

		snap.setPreferredSize(new Dimension(80, 50));
		snap.setMinimumSize(new Dimension(80, 50));
		snap.setMaximumSize(new Dimension(80, 50));
		add(snap);

		btnStart.setAlignmentX(CENTER_ALIGNMENT);
		add(Box.createRigidArea(new Dimension(50, 20)));
		add(btnStart);

	}

	private void startLapsing(int snaps, double interval) {

		if (interval < 0.15) {
			interval = 0.15;
		}
		if (!isRunning) {
			counter = 0;
			timer = new Timer((int) (interval * 1000), new ActionListener() {
				public void actionPerformed(ActionEvent e) {
					System.out.println(snaps);
					Toolkit.getDefaultToolkit().beep();
					counter++;
					count.setText("Taken so far : " + counter);

					if (snaps != 0) {
						if (counter == snaps) {
							timer.stop();
							timer = null;
							isRunning = false;
							btnStart.setText("Start");
						}
					}
				}
			});

			timer.start();
		} else {
			timer.stop();
			timer = null;
		}

		isRunning = !isRunning;
		count.setText("Taken so far : " + counter);
	}

}
